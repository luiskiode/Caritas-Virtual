<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>📌 Cáritas CNC — Beta (ordenado)</title>

  <!-- Estilos propios -->
  <link rel="stylesheet" href="styles.css">

  <!-- FullCalendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" />
  <script  src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js" defer></script>

  <!-- Leaflet (mapas) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>

  <!-- QR (generación y lectura) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js" defer></script>

  <!-- html2canvas para exportar credencial -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

  <!-- Manifest PWA -->
  <link rel="manifest" href="manifest.json" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js" defer></script>

  <!-- Supabase (v2 UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js" defer></script>
  
  <!-- Configs locales (deben existir) -->
  <script src="./firebase-config.js" defer></script>
  <script src="./supabase-config.js" defer></script>

  
</head>
<body>

  <!-- 🎥 Video de fondo -->
  <video id="video-fondo" autoplay muted loop>
    <source src="video/fondo.mp4" type="video/mp4" />
    Tu navegador no soporta video en HTML5.
  </video>

  <!-- Header / Nav -->
  <header class="app-header">
    <h1 id="appTitle">📌 Cáritas CNC</h1>
    <nav>
      <button data-goto="inicio">🏠 Inicio</button>
      <button id="btnRegistro" data-goto="registro-fam">👨‍👩‍👧 Registro Familias</button>
      <button id="btnServicios" data-goto="servicios" style="display:none;">⚙️ Servicios</button>
      <button id="btnPerfil" class="avatar-btn" data-goto="perfil" style="display:none;">
        <img id="navAvatar" class="avatar" src="img/avatar-placeholder.png" alt="Perfil" />
        <span>Mi perfil</span>
      </button>
      <button id="btnLogout" style="display:none;">🔒 Cerrar sesión</button>
    </nav>
  </header>

  <!-- Sección: Inicio -->
  <section id="inicio" class="seccion active">
    <div class="inicio-card">
      <div class="card" style="margin-top:1rem">
        <h2 id="bienvenida">👋 Bienvenid@ a Cáritas CNC ❤️</h2>
        <p id="mensajeInicio" class="muted">
          Plataforma de gestión para el voluntariado de Cáritas CNC. Registra familias, gestiona tareas y revisa la agenda.
        </p>
      </div>

      <!-- Pendientes (home, solo lectura) -->
      <div class="card" style="margin:.8rem 0 1.2rem">
        <div style="display:flex;align-items:center;gap:.5rem;justify-content:space-between">
          <h3 style="margin:0">📌 Mis pendientes</h3>
          <small class="pill">vista solo lectura</small>
        </div>
        <div id="pendientes-home-empty" style="display:none;color:#666;margin:.5rem 0">Sin pendientes aún.</div>
        <table aria-label="Tabla de pendientes" style="margin-top:.5rem">
          <thead>
            <tr><th>Tarea</th><th style="width:120px">Estado</th></tr>
          </thead>
          <tbody id="pendientesHomeBody"></tbody>
        </table>
        <div style="display:flex;justify-content:flex-end;margin-top:.5rem">
          <button class="btn-peque" data-goto="servicios">Gestionar ➝</button>
        </div>
      </div>

      <!-- Misión / Visión -->
      <div class="card">
        <div class="mision-vision">
          <div class="mision">
            <h3>🌟 Nuestra Misión</h3>
            <ul>
              <li>💖 Servir con amor, respeto y empatía a las familias más necesitadas.</li>
              <li>🙏 Guiarnos por la fe, el compromiso y la compasión.</li>
              <li>🤝 Promover dignidad, justicia y solidaridad.</li>
              <li>🌱 Trabajar unidos para crear oportunidades de desarrollo y esperanza.</li>
              <li>🔥 Transformar vidas a través de la acción social y el amor al prójimo.</li>
            </ul>
          </div>
          <div class="vision">
            <h3>🚀 Nuestra Visión</h3>
            <ul>
              <li>🏛 Ser un referente de servicio y apoyo a familias vulnerables.</li>
              <li>💡 Construir una comunidad justa, fraterna y solidaria.</li>
              <li>✝ Inspirarnos en el Evangelio para transformar realidades.</li>
              <li>🌍 Promover justicia social y desarrollo integral.</li>
              <li>🤗 Acompañar a cada familia con acogida y transformación.</li>
            </ul>
          </div>
          <p class="agradecimiento">🙏 ¡Gracias por ser parte de esta misión!</p>
        </div>
      </div>

      <!-- Galería -->
      <div class="card" style="margin-top:1rem">
        <h3>📷 Nuestra comunidad</h3>
        <div class="galeria-grid">
          <img src="img/imagen de grupo 1.jpeg" alt="Imagen 1" class="miniatura" />
          <img src="img/imagen de grupo 2.jpeg" alt="Imagen 2" class="miniatura" />
          <img src="img/imagen de grupo 3.jpeg" alt="Imagen 3" class="miniatura" />
          <img src="img/imagen de grupo 4.jpeg" alt="Imagen 4" class="miniatura" />
          <img src="img/imagen de grupo 5.jpeg" alt="Imagen 5" class="miniatura" />
        </div>
      </div>
    </div>
  </section>

  <!-- Modal galería -->
  <div id="modal" class="modal" aria-hidden="true" role="dialog" aria-label="Imagen ampliada">
    <span class="cerrar" id="modalClose" aria-label="Cerrar">&times;</span>
    <img class="modal-contenido" id="img-ampliada" alt="Vista ampliada" />
    <div id="caption" style="color:#fff; margin-top:.4rem"></div>
  </div>

  <!-- Registro de Familias -->
  <section id="registro-fam" class="seccion">
    <h2>📋 Registro de Familias</h2>
    <form id="familiaForm" class="card">
      <label>Nombres y Apellidos*</label>
      <input type="text" name="nombres_apellidos" required />

      <label>DNI*</label>
      <input type="text" name="dni_solicitante" maxlength="8" pattern="[0-9]{8}" required />

      <label>Apellido Familia*</label>
      <input type="text" name="apellido_familia" required />

      <label>Dirección*</label>
      <div style="display:flex; gap:0.5rem; align-items:center;">
        <input type="text" id="reg-direccion" name="direccion" required />
        <button type="button" id="btnAbrirMapa">📍 Validar</button>
      </div>

      <label>Fecha de Registro*</label>
      <input type="date" name="fecha_registro" required />

      <label>Teléfono*</label>
      <input type="text" name="telefono_contacto" pattern="[0-9]+" required />

      <label>Observaciones</label>
      <textarea name="observaciones"></textarea>

      <label>Adjuntar documento</label>
      <input type="file" name="archivo" accept=".pdf,.jpg,.png" />

      <label style="display:flex; gap:.5rem; align-items:center;">
        <input type="checkbox" required />
        <span>Acepto los <a href="terminos.html" target="_blank">términos</a></span>
      </label>

      <button type="submit">Guardar Familia</button>
    </form>
  </section>

  <!-- Perfil / Credencial -->
  <section id="perfil" class="seccion">
    <h2>👤 Mi perfil</h2>
    <p class="muted" style="margin-top:-.3rem">Gestiona tu credencial y tu foto de perfil.</p>

    <div class="perfil-grid">
      <!-- Ver credencial -->
      <div class="servicio-card">
        <h3>🪪 Ver Credencial</h3>
        <div id="credencialPreview" class="credencial-card card" aria-live="polite">
          <header>
            <img id="credPreviewFoto" src="img/avatar-placeholder.png" alt="Foto de perfil" />
            <div>
              <strong id="credPreviewNombre">Nombre Apellido</strong><br />
              <small id="credPreviewEmail" class="muted">correo@ejemplo.com</small><br />
              <small class="pill">Voluntariado Cáritas CNC</small>
            </div>
          </header>
          <div class="credencial-body">
            <div class="qr-wrap">
              <canvas id="qr-credencial" width="180" height="180" aria-label="Código QR de la credencial"></canvas>
            </div>
            <small id="credStatus" class="muted">Crea o actualiza tu credencial desde “Generar Credencial”.</small>
          </div>
        </div>
        <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.5rem">
          <button class="btn-peque" id="btnDescargarCred">⬇️ Descargar PNG</button>
          <button class="btn-peque" id="btnCopiarLink">🔗 Copiar enlace</button>
        </div>
      </div>

      <!-- Generar / Actualizar credencial -->
      <div class="servicio-card">
        <h3>⚙️ Generar / Actualizar Credencial</h3>
        <form id="credencialForm" class="card" autocomplete="on">
          <input type="text" id="nombre" placeholder="Nombre y Apellidos*" required />
          <input type="email" id="email" placeholder="Correo*" required />
          <input type="password" id="password" placeholder="Contraseña*" required />
          <label for="foto-perfil">Foto de perfil*</label>
          <input type="file" id="foto-perfil" accept="image/*" required />
          <button type="button" id="crear-credenciales">🪪 Generar Credencial</button>
        </form>
        <div style="display:none;margin-top:.6rem" id="credencialesAcciones">
          <button class="btn-peque" id="ver-credencial">Ver mi Credencial</button>
          <button class="btn-peque" id="btn-ver-todas">📂 Ver todas</button>
        </div>
      </div>

      <!-- Validar por QR -->
      <div class="servicio-card">
        <h3>✅ Validar Credencial por QR</h3>
        <p class="muted" style="margin-top:-.35rem">Apunta la cámara al código o sube una imagen con QR.</p>
        <div class="card">
          <video id="videoQR" style="width:100%;max-height:240px;border-radius:.6rem;background:#000" playsinline muted></video>
          <canvas id="canvasQR" style="display:none"></canvas>
          <div style="display:flex;gap:.5rem;margin-top:.5rem;flex-wrap:wrap">
            <button class="btn-peque" id="btnIniciarScan">🎥 Iniciar</button>
            <button class="btn-peque" id="btnDetenerScan">🛑 Detener</button>
            <input type="file" id="fileQR" accept="image/*" />
          </div>
          <div id="valResultado" style="margin-top:.6rem"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Servicios -->
  <section id="servicios" class="seccion">
    <h2>⚙️ Servicios</h2>

    <!-- Login simple -->
    <div id="loginCard" class="card">
      <h3>🔑 Iniciar Sesión</h3>
      <input type="email" id="login-email" placeholder="Correo" required />
      <input type="password" id="login-password" placeholder="Contraseña" required />
      <button id="btn-login">Iniciar Sesión</button>
    </div>

    <!-- Grid visible tras login -->
    <div id="serviciosGrid" style="display:none; gap:1rem; grid-template-columns:repeat(auto-fit,minmax(280px,1fr));">

      <!-- Calendario -->
      <div class="servicio-card">
        <h3>📅 Calendario</h3>
        <button id="toggle-calendario">📅 Ver Calendario de Actividades</button>
        <div id="calendario-container" style="display:none;max-width:900px">
          <div id="calendar"></div>
        </div>
      </div>

      <!-- Pendientes (gestión) -->
      <div class="servicio-card">
        <h3 id="toggle-pendientes" style="cursor:pointer;display:flex;justify-content:space-between;align-items:center">
          📋 Pendientes <span id="arrow-pendientes">▼</span>
        </h3>
        <div id="pendientes-contenido" style="display:none;">
          <div id="pendientesError" style="display:none;color:red;margin-bottom:8px;"></div>
          <form id="nuevoPendienteForm">
            <input type="text" id="nuevo-pendiente" placeholder="Escribe un pendiente..." required />
            <button type="submit">➕ Agregar</button>
          </form>
          <table id="pendientesTable" style="width:100%; margin-top:10px; border-collapse:collapse;">
            <thead>
              <tr>
                <th>Descripción</th>
                <th style="width:90px;text-align:center;">Hecho</th>
                <th style="width:90px;text-align:right;">Eliminar</th>
              </tr>
            </thead>
            <tbody id="pendientesBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Lista de Familias -->
      <div class="servicio-card">
        <h3>👨‍👩‍👧 Lista de Familias</h3>
        <button id="btn-ver-familias" onclick="window.open('familias-list.html','_blank')">Abrir lista de familias</button>
        <table id="familiasTable" style="display:none;">
          <thead>
            <tr><th>ID</th><th>Nombre</th><th>Dirección</th><th>Teléfono</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div>
  </section>

  <!-- Lógica principal (ordenada y depurada) -->
  <script>
  (function () {
    'use strict';

    // ==========================
    // Helpers y referencias base
    // ==========================
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    const nav = document.querySelector('.app-header nav');
    const appTitle = $('#appTitle');
    const btnLogout = $('#btnLogout');
    const serviciosGrid = $('#serviciosGrid');
    const loginCard = $('#loginCard');

    // Elementos Perfil / Credencial
    const credPreviewFoto = $('#credPreviewFoto');
    const credPreviewNombre = $('#credPreviewNombre');
    const credPreviewEmail = $('#credPreviewEmail');
    const credStatus = $('#credStatus');
    const qrCanvas = $('#qr-credencial');
    const btnDescargarCred = $('#btnDescargarCred');
    const btnCopiarLink = $('#btnCopiarLink');

    // Video/canvas para QR Scanner
    const video = $('#videoQR');
    const canvas = $('#canvasQR');
    const ctx = canvas ? canvas.getContext('2d') : null;
    let stream = null, raf = null;

    // Guardas para módulos externos
    const hasSupabase = typeof window.supabase !== 'undefined';
    const hasFirebase = typeof window.firebase !== 'undefined' && typeof window.auth !== 'undefined';

    // ==========================
    // Navegación entre secciones
    // ==========================
    function mostrarSeccion(id) {
      const sec = document.getElementById(id);
      if (!sec) { console.warn('Sección no encontrada:', id); return; }
      $$('.seccion').forEach(s => s.classList.remove('active'));
      sec.classList.add('active');
    }
    window.mostrarSeccion = mostrarSeccion;

    // Navegación por data-goto en botones del header y otros
    nav.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-goto]');
      if (!btn) return;
      e.preventDefault();
      const to = btn.getAttribute('data-goto');
      mostrarSeccion(to);
    });

    // ==========================
    // Galería (modal)
    // ==========================
    (function wireGaleria() {
      const modal = $('#modal');
      const modalImg = $('#img-ampliada');
      const modalClose = $('#modalClose');
      const caption = $('#caption');

      $$('.galeria-grid img').forEach((img) => {
        img.addEventListener('click', () => {
          modal.style.display = 'flex';
          modal.setAttribute('aria-hidden', 'false');
          modalImg.src = img.src;
          caption.textContent = img.alt || '';
        });
      });
      modalClose.addEventListener('click', () => {
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
      });
      modal.addEventListener('click', (e) => { if (e.target === modal) modalClose.click(); });
      window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.style.display === 'flex') modalClose.click(); });
    })();

    // ==========================
    // Validar dirección en Google Maps
    // ==========================
    function abrirMapa() {
      const dirEl = $('#reg-direccion');
      const dir = dirEl ? dirEl.value.trim() : '';
      const url = dir ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(dir)}` : 'https://www.google.com/maps/';
      window.open(url, '_blank');
    }
    $('#btnAbrirMapa')?.addEventListener('click', abrirMapa);
    window.abrirMapa = abrirMapa;

    // ==========================
    // Inicio: Pendientes (solo lectura)
    // ==========================
    async function renderPendientesHome() {
      const tbody = $('#pendientesHomeBody');
      const empty = $('#pendientes-home-empty');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!hasSupabase) {
        empty.style.display = 'block';
        return;
        }
      try {
        const { data, error } = await window.supabase.from('pendientes').select('descripcion, estado').order('id', { ascending: true });
        if (error) throw error;
        if (!data || data.length === 0) {
          empty.style.display = 'block';
          return;
        }
        empty.style.display = 'none';
        data.forEach(p => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${(p.descripcion||'').replace(/</g,'&lt;')}</td><td>${p.estado ? '✔️ Hecho' : '⏳ Pendiente'}</td>`;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error('Pendientes(home) error:', err);
        empty.style.display = 'block';
      }
    }

    // ==========================
    // Perfil / Credencial
    // ==========================
    function renderCredencialPreviewFromLocal() {
      const raw = localStorage.getItem('credencial');
      if (!raw) return;
      try {
        const data = JSON.parse(raw);
        credPreviewNombre.textContent = data.nombre || '—';
        credPreviewEmail.textContent = data.email || '—';
        if (data.foto_url) credPreviewFoto.src = data.foto_url;
        if (qrCanvas && window.QRCode) {
          const payload = { t:'credencial', v:1, nombre: data.nombre, email: data.email, uid: data.uid };
          QRCode.toCanvas(qrCanvas, JSON.stringify(payload), { width: 180 });
          credStatus.textContent = 'Credencial cargada (local).';
        }
      } catch {}
    }

    async function generarCredencial() {
      const btn = $('#crear-credenciales');
      const nombre = $('#nombre')?.value?.trim();
      const email = $('#email')?.value?.trim();
      const password = $('#password')?.value;
      const fotoInput = $('#foto-perfil');

      if (!nombre || !email || !password || !fotoInput?.files?.length) {
        alert('⚠️ Completa todos los campos (nombre, email, contraseña y foto).');
        return;
      }
      if (!hasFirebase) return alert('⚠️ Firebase Auth no está inicializado.');
      if (!hasSupabase) return alert('⚠️ Supabase no está inicializado.');

      btn.disabled = true;
      try {
        // 1) Crear usuario en Firebase
        const userCred = await window.auth.createUserWithEmailAndPassword(email, password);
        const uid = userCred?.user?.uid;
        if (!uid) throw new Error('No se pudo obtener UID.');

        // 2) Subir foto a Supabase Storage
        const file = fotoInput.files[0];
        const remotePath = `credenciales/${uid}-${file.name.replace(/[^a-zA-Z0-9._-]/g,'_')}`;
        const { error: uploadError } = await window.supabase.storage.from('fotos').upload(remotePath, file, { upsert: true });
        if (uploadError) throw uploadError;
        const { data: urlData } = window.supabase.storage.from('fotos').getPublicUrl(remotePath);
        const foto_url = urlData?.publicUrl || '';

        // 3) Insertar/actualizar tabla credenciales
        const codigo = Math.random().toString(36).substring(2, 8).toUpperCase();
        const payload = { uid, nombre, email, foto_url, codigo, creado_en: new Date().toISOString() };
        const { error: dbError } = await window.supabase.from('credenciales').upsert(payload, { onConflict: 'uid' });
        if (dbError) throw dbError;

        // 4) Actualizar UI + localStorage
        localStorage.setItem('credencial', JSON.stringify(payload));
        credPreviewNombre.textContent = nombre;
        credPreviewEmail.textContent = email;
        if (foto_url) credPreviewFoto.src = foto_url;
        if (qrCanvas && window.QRCode) {
          const qrPayload = { t:'credencial', v:1, nombre, email, uid };
          QRCode.toCanvas(qrCanvas, JSON.stringify(qrPayload), { width: 180 });
        }
        $('#credencialesAcciones').style.display = 'block';
        credStatus.textContent = 'Credencial generada/actualizada.';
        alert('✅ Credencial generada/actualizada');
      } catch (err) {
        console.error('Error credencial:', err);
        alert('❌ Error: ' + (err?.message || err));
      } finally {
        btn.disabled = false;
      }
    }

    function descargarCredencialPNG() {
      const card = $('#credencialPreview');
      if (!card) return;
      window.html2canvas(card).then((canvas) => {
        const link = document.createElement('a');
        link.download = 'credencial.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      });
    }

    function copiarLinkCredencial() {
      const raw = localStorage.getItem('credencial');
      if (!raw) { alert('Primero genera tu credencial.'); return; }
      const data = JSON.parse(raw);
      const payload = encodeURIComponent(JSON.stringify({ t:'credencial', v:1, nombre: data.nombre, email: data.email, uid: data.uid }));
      const link = `${location.origin}${location.pathname}?cred=${payload}`;
      navigator.clipboard.writeText(link).then(() => alert('🔗 Enlace copiado')).catch(() => alert(link));
    }

    function verMiCredencial() {
      if (!window.auth?.currentUser) { alert('⚠️ Inicia sesión para ver tu credencial.'); return; }
      const uid = window.auth.currentUser.uid;
      window.open(`carnet.html?id=${uid}`, '_blank');
    }

    // ==========================
    // QR: escanear / manejar payload
    // ==========================
    function handleQRPayload(data) {
      stopScan();
      try {
        const json = JSON.parse(data);
        if (json.t === 'credencial' && json.v >= 1) {
          $('#valResultado').innerHTML = `<div class="card"><strong class="pill">✅ Credencial válida</strong><br>Nombre: ${json.nombre}<br>Correo: ${json.email}<br><small>UID: ${json.uid}</small></div>`;
        } else {
          $('#valResultado').innerHTML = `<div class="card"><strong style="color:#b91c1c">⚠️ Código no reconocido</strong></div>`;
        }
      } catch {
        $('#valResultado').innerHTML = `<div class="card"><strong style="color:#b91c1c">⚠️ No es un JSON válido</strong></div>`;
      }
    }

    function scanLoop() {
      if (!video || !canvas || !ctx) return;
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = window.jsQR(imgData.data, imgData.width, imgData.height);
        if (code) { handleQRPayload(code.data); return; }
      }
      raf = requestAnimationFrame(scanLoop);
    }

    async function startScan() {
      if (!video) return;
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
        video.setAttribute('playsinline', true);
        await video.play();
        raf = requestAnimationFrame(scanLoop);
      } catch (err) {
        alert('No se pudo acceder a la cámara: ' + (err.message || err));
      }
    }

    function stopScan() {
      if (raf) cancelAnimationFrame(raf);
      raf = null;
      if (video) video.pause();
      if (video && video.srcObject) {
        video.srcObject.getTracks().forEach(t => t.stop());
        video.srcObject = null;
      }
    }

    // Cargar QR desde imagen
    $('#fileQR')?.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file || !canvas || !ctx) return;
      const img = new Image();
      img.onload = () => {
        canvas.width = img.width; canvas.height = img.height; ctx.drawImage(img, 0, 0);
        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = window.jsQR(imgData.data, imgData.width, imgData.height);
        if (code) handleQRPayload(code.data); else $('#valResultado').innerHTML = '<span style="color:#b91c1c">No se detectó QR en la imagen.</span>';
      };
      img.src = URL.createObjectURL(file);
    });

    $('#btnIniciarScan')?.addEventListener('click', startScan);
    $('#btnDetenerScan')?.addEventListener('click', stopScan);

    // ==========================
    // Calendario (FullCalendar + Supabase eventos)
    // ==========================
    async function cargarEventosCalendario() {
      if (!hasSupabase) return [];
      try {
        const { data, error } = await window.supabase.from('eventos').select('*');
        if (error) throw error;
        return (data||[]).map(evt => ({ id: evt.id, title: evt.titulo, start: evt.fecha_inicio, end: evt.fecha_fin || undefined, allDay: !!evt.all_day }));
      } catch (err) {
        console.error('Eventos error:', err);
        return [];
      }
    }

    let calendarInstance = null;
    async function toggleCalendario() {
      const cont = $('#calendario-container');
      const open = cont.style.display !== 'none';
      cont.style.display = open ? 'none' : 'block';
      if (!open && !calendarInstance) {
        const events = await cargarEventosCalendario();
        const el = $('#calendar');
        calendarInstance = new FullCalendar.Calendar(el, {
          initialView: 'dayGridMonth',
          locale: 'es',
          headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,timeGridDay' },
          events,
          editable: true,
          selectable: true,
          dateClick: async (info) => {
            const titulo = prompt('Ingrese título del evento:'); if (!titulo) return;
            try {
              const { data, error } = await window.supabase.from('eventos').insert([{ titulo, fecha_inicio: info.dateStr, all_day: true }]).select().single();
              if (error) throw error;
              calendarInstance.addEvent({ id: data.id, title: data.titulo, start: data.fecha_inicio, allDay: data.all_day });
            } catch (err) { alert('❌ Error al guardar en Supabase: ' + (err.message||err)); }
          },
          eventChange: async (info) => {
            try {
              const { error } = await window.supabase.from('eventos').update({ fecha_inicio: info.event.start, fecha_fin: info.event.end || null, all_day: info.event.allDay }).eq('id', info.event.id);
              if (error) throw error;
            } catch (err) { alert('❌ Error al actualizar evento: ' + (err.message||err)); }
          },
          eventClick: async (info) => {
            if (!confirm(`¿Eliminar evento "${info.event.title}"?`)) return;
            try {
              const { error } = await window.supabase.from('eventos').delete().eq('id', info.event.id);
              if (error) throw error;
              info.event.remove();
              alert('🗑️ Evento eliminado');
            } catch (err) { alert('❌ Error al eliminar evento: ' + (err.message||err)); }
          }
        });
        calendarInstance.render();
      }
    }
    $('#toggle-calendario')?.addEventListener('click', toggleCalendario);

    // ==========================
    // Pendientes (gestión CRUD)
    // ==========================
    (function wirePendientesCRUD(){
      const header = $('#toggle-pendientes');
      const content = $('#pendientes-contenido');
      const arrow = $('#arrow-pendientes');
      const tbody = $('#pendientesBody');
      let abierto = false;

      function toast(msg, ok=true){
        const cont = content || document.body;
        const el = document.createElement('div');
        el.textContent = msg;
        el.style.cssText = `position:relative;background:${ok?'#16a34a':'#dc2626'};color:#fff;padding:10px 12px;border-radius:10px;margin:8px 0;text-align:center;font-weight:600;box-shadow:0 6px 14px rgba(0,0,0,.15)`;
        cont.prepend(el);
        setTimeout(()=>el.remove(), 2200);
      }

      async function load(){
        if (!hasSupabase) { tbody.innerHTML = '<tr><td colspan="3">Supabase no inicializado</td></tr>'; return; }
        const { data, error } = await window.supabase.from('pendientes').select('id, descripcion, estado').order('id', { ascending:true });
        if (error) { console.error(error); tbody.innerHTML = '<tr><td colspan="3">Error cargando</td></tr>'; return; }
        tbody.innerHTML = '';
        if (!data || data.length===0){ tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#888">No hay pendientes</td></tr>'; return; }
        data.forEach(t => {
          const tr = document.createElement('tr');
          tr.dataset.id = t.id;
          tr.innerHTML = `
            <td class="desc" style="padding-right:8px;">${(t.descripcion||'').replace(/</g,'&lt;')}</td>
            <td style="text-align:center;"><input class="chk-estado" type="checkbox" ${t.estado?'checked':''} /></td>
            <td style="text-align:right;"><button class="btn-del btn-peque">🗑️</button></td>`;
          tbody.appendChild(tr);
        });
      }

      async function add(desc){
        desc = (desc||'').trim(); if (!desc) return;
        const { error } = await window.supabase.from('pendientes').insert([{ descripcion: desc, estado:false }]);
        if (error) return toast('Error al agregar', false);
        toast('✅ Agregado');
        load();
      }

      async function upd(id, estado){
        const { error } = await window.supabase.from('pendientes').update({ estado }).eq('id', id);
        if (error) toast('No se pudo actualizar', false);
      }

      async function del(id){
        const { error } = await window.supabase.from('pendientes').delete().eq('id', id);
        if (error) return toast('No se pudo eliminar', false);
        toast('🗑️ Eliminado');
        load();
      }

      header?.addEventListener('click', () => {
        abierto = !abierto;
        content.style.display = abierto ? 'block' : 'none';
        if (arrow) arrow.textContent = abierto ? '▲' : '▼';
        if (abierto) setTimeout(load, 60);
      });

      $('#nuevoPendienteForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const input = $('#nuevo-pendiente');
        add(input.value);
        input.value = '';
        input.focus();
      });

      tbody?.addEventListener('change', (e) => {
        const chk = e.target.closest('.chk-estado'); if (!chk) return;
        const tr = e.target.closest('tr'); if (!tr) return;
        upd(tr.dataset.id, chk.checked);
      });
      tbody?.addEventListener('click', (e) => {
        const btn = e.target.closest('.btn-del'); if (!btn) return;
        const tr = e.target.closest('tr'); if (!tr) return;
        if (confirm('¿Seguro de eliminar este pendiente?')) del(tr.dataset.id);
      });

      // Exponer por si hace falta en consola
      window._pendientes = { load, add, upd, del };
    })();

    // ==========================
    // Registro de Familias (envío a Supabase REST)
    // ==========================
    $('#familiaForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!hasSupabase) return alert('Supabase no inicializado');

      const fd = new FormData(e.target);
      try {
        // Subida de archivo (opcional) a Storage "documentosfamilias"
        let archivoURL = null;
        const archivo = fd.get('archivo');
        if (archivo && archivo.size > 0) {
          const safeName = `${Date.now()}_${archivo.name.replace(/[^a-zA-Z0-9._-]/g,'_').slice(0,80)}`;
          const { error: uploadError } = await window.supabase.storage.from('documentosfamilias').upload(safeName, archivo, { upsert:false, contentType: archivo.type });
          if (uploadError) throw uploadError;
          archivoURL = `${window.supabaseUrl || ''}/storage/v1/object/public/documentosfamilias/${safeName}`;
        }

        const payload = {
          nombres_apellidos: fd.get('nombres_apellidos'),
          dni_solicitante: fd.get('dni_solicitante'),
          apellido_familia: fd.get('apellido_familia'),
          direccion: fd.get('direccion'),
          fecha_registro: fd.get('fecha_registro'),
          telefono_contacto: fd.get('telefono_contacto'),
          observaciones: fd.get('observaciones') || null,
          archivo_url: archivoURL,
          creado_en: new Date().toISOString()
        };
        const { error } = await window.supabase.from('familias').insert([payload]);
        if (error) throw error;
        alert('✅ Familia registrada correctamente');
        e.target.reset();
      } catch (err) {
        console.error('Familias error:', err);
        alert('❌ Error al registrar familia: ' + (err.message || err));
      }
    });

    // ==========================
    // Login simple (Firebase Auth)
    // ==========================
    async function doLogin(){
      if (!hasFirebase) return alert('Firebase no inicializado');
      const email = $('#login-email').value;
      const password = $('#login-password').value;
      try {
        await window.auth.signInWithEmailAndPassword(email, password);
        alert('✅ Sesión iniciada');
        loginCard.style.display = 'none';
        serviciosGrid.style.display = 'grid';
        $('#btnServicios').style.display = '';
        $('#btnPerfil').style.display = '';
        $('#btnLogout').style.display = '';
      } catch (err) { alert('❌ Error: ' + (err.message||err)); }
    }
    $('#btn-login')?.addEventListener('click', doLogin);

    btnLogout?.addEventListener('click', async () => {
      try { await window.auth?.signOut(); } catch {}
      location.reload();
    });

    appTitle?.addEventListener('click', () => {
      mostrarSeccion('servicios');
      if (!window.auth?.currentUser) { loginCard.style.display = 'block'; serviciosGrid.style.display = 'none'; }
      $('#login-email')?.focus();
    });

    // ==========================
    // Botones/acciones Perfil
    // ==========================
    $('#crear-credenciales')?.addEventListener('click', generarCredencial);
    $('#ver-credencial')?.addEventListener('click', verMiCredencial);
    btnDescargarCred?.addEventListener('click', descargarCredencialPNG);
    btnCopiarLink?.addEventListener('click', copiarLinkCredencial);

    // ==========================
    // Auto-preview si llega ?cred=...
    // ==========================
    (function autoPreviewCredDesdeURL(){
      const urlParams = new URLSearchParams(location.search);
      if (!urlParams.has('cred')) return;
      try {
        const payload = JSON.parse(decodeURIComponent(urlParams.get('cred')));
        if (payload?.nombre){
          mostrarSeccion('perfil');
          credPreviewNombre.textContent = payload.nombre;
          credPreviewEmail.textContent = payload.email || '(sin correo)';
          if (qrCanvas && window.QRCode) QRCode.toCanvas(qrCanvas, JSON.stringify(payload), { width: 180 });
          credStatus.textContent = 'Vista de credencial compartida.';
        }
      } catch {}
    })();

    // ==========================
    // Inicialización al cargar
    // ==========================
    document.addEventListener('DOMContentLoaded', () => {
      // Refrescar tarjetas home
      renderPendientesHome();
      renderCredencialPreviewFromLocal();

      // Mostrar botones según sesión existente
      if (window.auth?.currentUser) {
        $('#btnServicios').style.display = '';
        $('#btnPerfil').style.display = '';
        $('#btnLogout').style.display = '';
      }
    });
  })();
  </script>
</body>
</html>
