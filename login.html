<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Iniciar Sesi√≥n - C√°ritas CNC</title>
  <link rel="stylesheet" href="styles.css?v=2" />

  <!-- Firebase compat v10 -->
  <script defer src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script defer src="firebase-config.js"></script>
</head>
<body class="login-body">

<main class="login-container" role="main">
  <h1>C√°ritas CNC</h1>
  <h2>Iniciar sesi√≥n</h2>

  <form id="loginForm" autocomplete="on" novalidate>
    <label for="email">Correo</label>
    <input type="email" id="email" autocomplete="username" required />

    <label for="password">Contrase√±a</label>
    <input type="password" id="password" autocomplete="current-password" required />

    <button type="submit" class="submit-btn">Ingresar</button>
  </form>

  <p id="loginMessage" role="alert" aria-live="polite"></p>

  <div style="text-align:center; margin-top:.5rem;">
    <button class="btn-big" id="resetPassBtn">¬øOlvidaste tu contrase√±a?</button>
  </div>
</main>

<!-- Modal recuperaci√≥n de contrase√±a -->
<div id="modalReset" class="modal">
  <div class="modal-content">
    <h3>Recuperar contrase√±a</h3>
    <input type="email" id="resetEmail" placeholder="Ingresa tu correo" />
    <button id="sendReset">Enviar enlace</button>
    <button onclick="closeModal()">Cerrar</button>
    <p id="resetMessage"></p>
  </div>
</div>

<script>
console.log("‚úÖ login.js cargado");

// LOGIN
document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const msg = document.getElementById('loginMessage');
  msg.textContent = '';
  msg.classList.remove('error', 'success');

  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;

  if (!email || !password) {
    msg.textContent = 'Por favor completa email y contrase√±a.';
    msg.classList.add('error');
    return;
  }

  try {
    const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
    const user = userCredential.user;

    // Verificar si es admin
    if (user.email !== 'admin@caritas.com') {
      await firebase.auth().signOut();
      msg.textContent = '‚õî No tienes permisos para acceder a esta p√°gina.';
      msg.classList.add('error');
      return;
    }

    msg.textContent = '‚úî Acceso concedido. Redirigiendo‚Ä¶';
    msg.classList.add('success');

    // Guardar sesi√≥n en localStorage
    localStorage.setItem("caritasUser", JSON.stringify({ email: user.email, uid: user.uid }));

    setTimeout(() => window.location.href = 'index.html', 1000);

  } catch (err) {
    console.error(err);
    let errorMessage = 'Usuario o contrase√±a incorrectos.';
    if (err.code === 'auth/network-request-failed') {
      errorMessage = 'Error de red. Verifica tu conexi√≥n.';
    }
    msg.textContent = errorMessage;
    msg.classList.add('error');
  }
});

// MODAL DE RECUPERACI√ìN DE CONTRASE√ëA
const modal = document.getElementById('modalReset');
const resetBtn = document.getElementById('resetPassBtn');
const sendResetBtn = document.getElementById('sendReset');
const resetMessage = document.getElementById('resetMessage');

resetBtn.addEventListener('click', () => {
  modal.style.display = 'flex';
  resetMessage.textContent = '';
  document.getElementById('resetEmail').value = '';
});

function closeModal() {
  modal.style.display = 'none';
}

sendResetBtn.addEventListener('click', async () => {
  const email = document.getElementById('resetEmail').value.trim();
  resetMessage.textContent = '';
  resetMessage.classList.remove('success', 'error');

  if (!email) {
    resetMessage.textContent = 'Por favor ingresa un correo.';
    resetMessage.classList.add('error');
    return;
  }

  try {
    await firebase.auth().sendPasswordResetEmail(email);
    resetMessage.textContent = 'üì© Si el correo existe, se envi√≥ un enlace de recuperaci√≥n.';
    resetMessage.classList.add('success');
  } catch (err) {
    console.error(err);
    resetMessage.textContent = '‚ùå No se pudo enviar el correo de recuperaci√≥n.';
    resetMessage.classList.add('error');
  }
});

// Cerrar modal al hacer clic fuera
window.addEventListener('click', (e) => {
  if (e.target === modal) closeModal();
});
</script>

</body>
</html>
