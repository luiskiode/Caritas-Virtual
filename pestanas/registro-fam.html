<section class="registro-familias" aria-labelledby="regfam-title">
  <h2 id="regfam-title">👨‍👩‍👧 Registro de Familias</h2>

  <div id="regfam-guard" class="card" style="display:none">
    <h3>🔒 Acceso restringido</h3>
    <p>Para registrar o ver familias debes iniciar sesión.</p>
    <div style="display:flex;gap:.5rem;flex-wrap:wrap">
      <button class="btn" id="goLoginFromFam">🔑 Ir a login</button>
      <a class="btn" href="#inicio">🏠 Ir a inicio</a>
    </div>
  </div>

  <div id="regfam-wrap" style="display:none">
    <div class="card">
      <form id="familiaForm" autocomplete="on">
        <div class="grid" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <label>🧑‍🦱 Nombres y Apellidos*</label>
            <input type="text" name="nombres_apellidos" required />
          </div>
          <div>
            <label>🆔 DNI*</label>
            <input type="text" name="dni_solicitante" maxlength="8" pattern="[0-9]{8}" required />
          </div>
          <div>
            <label>👪 Apellido de la Familia</label>
            <input type="text" name="apellido_familia" />
          </div>
          <div>
            <label>📞 Teléfono*</label>
            <input type="text" name="telefono_contacto" pattern="[0-9]+" required />
          </div>
          <div style="grid-column:1/-1">
            <label>🏠 Dirección*</label>
            <input type="text" name="direccion" required />
          </div>
          <div>
            <label>📅 Fecha Registro</label>
            <input type="date" name="fecha_registro" />
          </div>
          <div>
            <label>📎 Documento (opcional)</label>
            <input type="file" name="archivo" accept=".pdf,.jpg,.jpeg,.png" />
          </div>
          <div style="grid-column:1/-1">
            <label>📝 Observaciones</label>
            <textarea name="observaciones" rows="3"></textarea>
          </div>
        </div>

        <div class="terms" style="margin-top:.6rem">
          <label style="display:flex;gap:.5rem;align-items:flex-start">
            <input type="checkbox" id="chkTyC" />
            <span>Acepto los <a href="#" id="verTyC">Términos y Condiciones</a> y autorizo el tratamiento de datos para fines de asistencia social.</span>
          </label>
        </div>

        <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.8rem">
          <button type="submit" class="submit-btn" id="btnGuardar" disabled>💾 Guardar</button>
          <button type="reset" class="btn">↩️ Limpiar</button>
          <a class="btn" href="familias-listado.html" target="_blank" rel="noopener">🌐 Ver listado completo</a>
        </div>
      </form>
    </div>

    <div class="card" style="margin-top:1rem">
      <h3>🗂️ Últimos registros</h3>
      <table aria-label="Últimos registros de familias" style="width:100%;border-collapse:collapse">
        <thead>
          <tr>
            <th style="text-align:left;padding:.5rem;border-bottom:1px solid var(--border,#eee)">Nombres</th>
            <th style="text-align:left;padding:.5rem;border-bottom:1px solid var(--border,#eee)">Dirección</th>
            <th style="text-align:left;padding:.5rem;border-bottom:1px solid var(--border,#eee)">Fecha</th>
          </tr>
        </thead>
        <tbody id="familias-tbody"></tbody>
      </table>
      <div id="fam-empty" class="muted" hidden>Sin registros.</div>
    </div>
  </div>

  <!-- Modal T&C -->
  <div id="tycModal" class="modal" aria-hidden="true" role="dialog" aria-label="Términos y Condiciones">
    <button class="cerrar" id="tycClose" aria-label="Cerrar">✖️</button>
    <div class="card" style="max-width:720px">
      <h3>📜 Términos y Condiciones</h3>
      <p>Autorizo a Cáritas CNC a tratar mis datos personales para fines de identificación, contacto y asistencia social conforme a la normativa vigente. Los datos no serán cedidos a terceros sin consentimiento, salvo obligación legal.</p>
      <p>Puedo solicitar la rectificación o eliminación de mis datos a través de los canales oficiales de la organización.</p>
      <div style="text-align:right"><button class="btn" id="aceptarTyC">Aceptar</button></div>
    </div>
  </div>
</section>

<script>
(() => {
  'use strict';

  const supabase = window.CARITAS?.supabase;
  const auth     = window.CARITAS?.auth;

  const guard    = document.getElementById('regfam-guard');
  const wrap     = document.getElementById('regfam-wrap');
  const goLogin  = document.getElementById('goLoginFromFam');

  const form     = document.getElementById('familiaForm');
  const chkTyC   = document.getElementById('chkTyC');
  const btnSave  = document.getElementById('btnGuardar');

  const famTbody = document.getElementById('familias-tbody');
  const famEmpty = document.getElementById('fam-empty');

  const tycModal = document.getElementById('tycModal');
  const tycClose = document.getElementById('tycClose');
  const verTyC   = document.getElementById('verTyC');
  const aceptarTyC = document.getElementById('aceptarTyC');

  // Guard acceso
  function showGuard(){ guard.style.display='block'; wrap.style.display='none'; }
  function showForm(){ guard.style.display='none'; wrap.style.display='block'; }

  goLogin?.addEventListener('click', () => { sessionStorage.setItem('caritas:next', '#registro-fam'); location.href='login.html'; });

  function checkAuthAndRender(){
    const logged = !!(auth?.currentUser) || (()=>{try{ return !!JSON.parse(localStorage.getItem('caritasUser'))?.uid }catch{return false}})();
    if (!logged) showGuard(); else showForm();
  }

  // TyC
  verTyC?.addEventListener('click', (e)=>{ e.preventDefault(); tycModal.style.display='flex'; tycModal.setAttribute('aria-hidden','false'); });
  tycClose?.addEventListener('click', ()=>{ tycModal.style.display='none'; tycModal.setAttribute('aria-hidden','true'); });
  aceptarTyC?.addEventListener('click', ()=>{ chkTyC.checked = true; btnSave.disabled = false; tycClose.click(); });
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && tycModal?.style.display==='flex') tycClose.click(); });

  chkTyC?.addEventListener('change', ()=>{ btnSave.disabled = !chkTyC.checked; });

  async function cargarUltimos(){
    famTbody.innerHTML = ''; famEmpty.hidden=true;
    try{
      const { data, error } = await supabase
        .from('familias')
        .select('nombres_apellidos,direccion,fecha_registro')
        .order('id', { ascending:false })
        .limit(10);
      if (error) throw error;
      if (!data || data.length===0){ famEmpty.hidden=false; return; }
      data.forEach(f=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td style="padding:.5rem;border-bottom:1px solid var(--border,#eee)">${(f.nombres_apellidos||'').replace(/</g,'&lt;')}</td>
          <td style="padding:.5rem;border-bottom:1px solid var(--border,#eee)">${(f.direccion||'').replace(/</g,'&lt;')}</td>
          <td style="padding:.5rem;border-bottom:1px solid var(--border,#eee)">${(f.fecha_registro||'')}</td>`;
        famTbody.appendChild(tr);
      });
    }catch(err){
      console.error('Familias error:', err);
      famEmpty.hidden=false; famEmpty.textContent='Error al cargar familias.';
    }
  }

  // Subida + insert
  async function uploadArchivoIfAny(file){
    if (!file) return null;
    const safe = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9._-]/g,'_').slice(0,80)}`;
    const { data, error } = await supabase.storage.from('documentosfamilias').upload(safe, file, { cacheControl:'3600', upsert:false });
    if (error) throw error;
    const pub = supabase.storage.from('documentosfamilias').getPublicUrl(data.path);
    return pub?.data?.publicUrl || null;
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!chkTyC.checked){ alert('Debes aceptar los Términos y Condiciones.'); return; }

    const fd = new FormData(form);
    const payload = {
      nombres_apellidos: fd.get('nombres_apellidos'),
      dni_solicitante: fd.get('dni_solicitante'),
      apellido_familia: fd.get('apellido_familia'),
      direccion: fd.get('direccion'),
      fecha_registro: fd.get('fecha_registro') || new Date().toISOString().slice(0,10),
      telefono_contacto: fd.get('telefono_contacto'),
      observaciones: fd.get('observaciones')
    };
    try{
      const archivo = fd.get('archivo');
      const archivo_url = archivo && archivo.size ? await uploadArchivoIfAny(archivo) : null;

      const { error } = await supabase.from('familias').insert([{ ...payload, archivo_url }]);
      if (error) throw error;

      window.enviarNotificacion?.('Cáritas CNC', `✅ Familia registrada: ${payload.nombres_apellidos}`);
      alert('✅ Familia registrada correctamente');
      form.reset(); btnSave.disabled = true;
      cargarUltimos();
    }catch(err){
      console.error(err);
      alert('❌ No se pudo registrar la familia');
    }
  });

  // Init
  checkAuthAndRender();
  cargarUltimos();
  document.addEventListener('firebase:ready:caritas', checkAuthAndRender);
})();
</script>