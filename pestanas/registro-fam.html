<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro de Familias ‚Äî C√°ritas CNC</title>
  <link rel="stylesheet" href="estilos-familias.css">

  <!-- Fuente profesional -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    body, input, textarea, button, a {
      font-family: 'Poppins', sans-serif;
    }
    h2 {
      font-weight: 600;
      text-align: center;
      margin-bottom: 10px;
    }
    h2 a {
      color: #4da3ff;
      text-decoration: underline;
      cursor: pointer;
    }
    p {
      font-weight: 300;
      text-align: center;
    }
    .card {
      padding: 20px;
      border-radius: 12px;
      background: #2a2a2a;
      box-shadow: 0 4px 12px rgba(0,0,0,.4);
      max-width: 700px;
      margin: 2rem auto;
    }
    #btnValidar {
      background-color: #007bff;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      white-space: nowrap;
      border: none;
    }
    #btnValidar:hover {
      background-color: #0056b3;
    }
  </style>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="api.js/supabase-config-caritas.js"></script>

  <!-- Notificaciones -->
  <script src="notificaciones.js"></script>
</head>
<body>
  <div class="container">
    <div class="card">
      <h2>
        Formulario de <a href="pestanas/familias-list.html" target="_blank">Registro</a>
      </h2>
      <p>Complete todos los datos requeridos para registrar su solicitud de ayuda.</p>

      <form id="famForm" enctype="multipart/form-data">
        <label>Nombre y apellidos del solicitante:</label>
        <input type="text" id="name" required>

        <label>DNI del solicitante:</label>
        <input type="text" id="dni" required>

        <label>Apellido de la familia:</label>
        <input type="text" id="family_name" required>

        <label>Fecha de registro de solicitud de ayuda:</label>
        <input type="date" id="registration_date" required>

        <label>Tel√©fono de contacto:</label>
        <input type="tel" id="contact_phone" required>

        <label>Observaciones:</label>
        <textarea id="observations" rows="4" required></textarea>

        <label>Direcci√≥n de la familia:</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="text" id="family_address" placeholder="Ej: Calle 123, Ciudad" required style="flex:1">
          <button type="button" id="btnValidar">üìç Validar direcci√≥n</button>
        </div>

        <label>Subir archivo de registro:</label>
        <input type="file" id="archivo" accept=".pdf,.doc,.docx">

        <label style="display:flex;align-items:center;gap:.4rem;margin-top:10px">
          <input type="checkbox" id="acceptTerms" required>
          Acepto <a href="terminos.html" target="_blank">t√©rminos y condiciones</a>
        </label>

        <button type="submit">‚úÖ Registrar familia</button>
      </form>
      <p id="famMsg"></p>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const form = document.getElementById('famForm');
  const msg = document.getElementById('famMsg');
  const btnValidar = document.getElementById('btnValidar');

  // Abrir mapa en pesta√±a aparte
  btnValidar.addEventListener('click', ()=>{
    const dir = document.getElementById('family_address').value.trim();
    if(!dir){
      alert("Ingrese la direcci√≥n primero");
      return;
    }
    const url = `validar-direccion.html?dir=${encodeURIComponent(dir)}`;
    window.open(url, "_blank", "noopener,noreferrer");
  });

  // Guardar familia
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    msg.textContent='';

    const nombre = name.value.trim();
    const dni = document.getElementById('dni').value.trim();
    const apellido = family_name.value.trim();
    const fecha = registration_date.value;
    const telefono = contact_phone.value.trim();
    const obs = observations.value.trim();
    const direccion = family_address.value.trim();
    const archivo = document.getElementById('archivo').files[0];

    if(!acceptTerms.checked){
      msg.textContent='‚ö†Ô∏è Debes aceptar los t√©rminos.';
      return;
    }

    try{
      let archivo_url = null;
      if(archivo){
        const { data, error: upErr } = await window.CARITAS.supabase.storage
          .from('familias-files')
          .upload(`${Date.now()}_${archivo.name}`, archivo);
        if(upErr) throw upErr;
        archivo_url = data.path;
      }

      const { error } = await window.CARITAS.supabase.from('familias').insert({
        nombre, dni, apellido, fecha, telefono, observaciones: obs,
        direccion, archivo_url, visitada:false, creado_en:new Date().toISOString()
      });
      if(error) throw error;

      msg.textContent='‚úÖ Familia registrada correctamente.';
      form.reset();

      // üîî Notificaci√≥n + vibraci√≥n
      if (typeof enviarNotificacion === "function") {
        enviarNotificacion("Familia registrada", "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Se guard√≥ correctamente en el sistema");
      }
      if ("vibrate" in navigator) {
        navigator.vibrate(200);
      }

    }catch(err){
      console.error(err);
      msg.textContent='‚ùå Error al registrar familia.';
    }
  });
});
</script>
</body>
</html>