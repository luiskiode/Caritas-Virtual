<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Validar Credencial - C√°ritas CNC</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; background:#f6f7fb; margin:0; text-align:center; }
    header { background:#b71c1c; color:#fff; padding:16px; font-weight:700; }
    #video { width: 100%; max-width: 420px; border: 3px solid #b71c1c; border-radius: 10px; margin-top: 14px; background:#000; }
    #output { margin: 16px auto; font-size: 1rem; max-width: 480px; }
    #card { background:#fff; border:1px solid #eee; border-radius: 12px; padding: 12px; display:none; width: 340px; margin: 10px auto; box-shadow: 0 6px 16px rgba(0,0,0,.06); }
    .foto { width: 88px; height: 88px; border-radius:50%; border:2px solid #b91c1c; object-fit:cover; }
    .muted { color:#6b7280; }
    .btn { padding: 8px 12px; border:1px solid #ddd; background:#fafafa; border-radius:8px; cursor:pointer; }
    .btn:hover { background:#f0f0f0; }
  </style>
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="./supabase-config.js"></script>
</head>
<body>
  <header>Validar Credencial</header>

  <video id="video" autoplay playsinline></video>
  <div class="row" style="margin-top:10px;">
    <button class="btn" id="btnIniciar">üé• Iniciar</button>
    <button class="btn" id="btnDetener">üõë Detener</button>
    <input type="file" id="fileQR" accept="image/*" class="btn" />
  </div>

  <div id="output" class="muted">Apunta la c√°mara a un QR con el enlace o JSON de credencial.</div>
  <div id="card">
    <img id="foto" class="foto" alt="Foto">
    <div style="margin-top:6px;">
      <div><strong id="nombre">‚Äî</strong></div>
      <div class="muted" id="email">‚Äî</div>
      <div class="muted">C√≥digo: <span id="codigo">‚Äî</span></div>
    </div>
  </div>

<script>
(function(){
  'use strict';
  const video = document.getElementById('video');
  const output = document.getElementById('output');
  const card = document.getElementById('card');
  const foto = document.getElementById('foto');
  const nombre = document.getElementById('nombre');
  const email = document.getElementById('email');
  const codigo = document.getElementById('codigo');

  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  let stream=null, raf=null;

  function avatar(n){ return `https://ui-avatars.com/api/?name=${encodeURIComponent(n||'Usuario')}&background=004aad&color=fff`; }

  function setMsg(html){ output.innerHTML = html; }

  function parseQR(data){
    // Soporta URL del tipo .../credencial.html?id=UID o JSON {"t":"credencial","uid":"..."}
    try {
      const url = new URL(data);
      const uid = url.searchParams.get('id');
      if (uid) return { uid };
    } catch {}
    try {
      const json = JSON.parse(data);
      if (json && json.uid) return { uid: json.uid };
    } catch {}
    return null;
  }

  async function cargar(uid){
    try {
      const { data, error } = await window.supabase.from('credenciales').select('*').eq('uid', uid).single();
      if (error || !data) throw error || new Error('No encontrada');
      foto.src = data.foto_url || avatar(data.nombre);
      nombre.textContent = data.nombre || '‚Äî';
      email.textContent = data.email || '‚Äî';
      codigo.textContent = data.codigo || 'N/A';
      card.style.display = 'block';
      setMsg('<span style="color:#16a34a;font-weight:700">‚úÖ Credencial v√°lida</span>');
    } catch(e){
      console.error(e);
      card.style.display = 'none';
      setMsg('<span style="color:#b91c1c;font-weight:700">‚ùå Credencial no v√°lida</span>');
    }
  }

  function scanLoop(){
    if (!video || !canvas || !ctx) return;
    if (video.readyState === video.HAVE_ENOUGH_DATA){
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const img = ctx.getImageData(0,0,canvas.width, canvas.height);
      const code = jsQR(img.data, img.width, img.height, { inversionAttempts: 'dontInvert' });
      if (code){
        const parsed = parseQR(code.data);
        if (parsed && parsed.uid){ detener(); cargar(parsed.uid); return; }
      }
    }
    raf = requestAnimationFrame(scanLoop);
  }

  async function iniciar(){
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = stream;
      video.setAttribute('playsinline', true);
      await video.play();
      setMsg('Escaneando...');
      raf = requestAnimationFrame(scanLoop);
    } catch(err){
      console.error(err);
      setMsg('<span style="color:#b91c1c">‚ùå No se pudo acceder a la c√°mara.</span>');
    }
  }
  function detener(){
    if (raf) cancelAnimationFrame(raf);
    raf=null;
    if (video) video.pause();
    if (video && video.srcObject){ video.srcObject.getTracks().forEach(t=>t.stop()); video.srcObject=null; }
    setMsg('Escaneo detenido.');
  }

  document.getElementById('btnIniciar').addEventListener('click', iniciar);
  document.getElementById('btnDetener').addEventListener('click', detener);

  // Cargar QR desde imagen
  document.getElementById('fileQR').addEventListener('change', (e)=>{
    const file = e.target.files?.[0];
    if (!file) return;
    const img = new Image();
    img.onload = () => {
      canvas.width = img.width; canvas.height = img.height; ctx.drawImage(img, 0, 0);
      const data = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(data.data, data.width, data.height, { inversionAttempts: 'dontInvert' });
      if (code){
        const parsed = parseQR(code.data);
        if (parsed && parsed.uid){ cargar(parsed.uid); }
        else setMsg('<span style="color:#b91c1c">QR sin UID v√°lido.</span>');
      } else setMsg('<span style="color:#b91c1c">No se detect√≥ QR.</span>');
    };
    img.src = URL.createObjectURL(file);
  });
})();
</script>

</body>
</html>
