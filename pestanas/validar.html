<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Validar Credencial ‚Äî C√°ritas CNC</title>

  <style>
    :root{
      --primary:#b71c1c;
      --surface:#fff;
      --border:#eee;
      --muted:#6b7280;
      --bg:#f6f7fb;
    }
    body{
      font-family:system-ui, Arial, sans-serif; background:var(--bg); margin:0; color:#111; text-align:center;
    }
    header{ background:var(--primary); color:#fff; padding:16px; font-weight:700; }
    .wrap{ max-width:960px; margin:0 auto; padding:12px 16px; }
    .controls{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; align-items:center; margin-top:10px;}
    .btn, select, input[type="file"]{
      padding:8px 12px; border:1px solid var(--border); background:#fafafa; border-radius:8px; cursor:pointer;
    }
    .btn:hover{ background:#f0f0f0; }
    #video{
      width:100%; max-width:460px; aspect-ratio:3/4; background:#000; border:3px solid var(--primary); border-radius:10px; margin:14px auto 0; object-fit:cover;
    }
    /* overlay de escaneo */
    .scan-frame{
      position:relative; display:inline-block;
    }
    .scan-frame::after{
      content:""; position:absolute; inset:8% 8%;
      border:2px dashed rgba(255,255,255,.7); border-radius:12px; pointer-events:none;
    }
    #output{ margin:12px auto; font-size:1rem; max-width:520px; color:var(--muted); }
    #output strong{ color:#111; }
    #card{
      background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:14px;
      display:none; width:340px; margin:10px auto; box-shadow:0 6px 16px rgba(0,0,0,.06); text-align:center;
    }
    .foto{ width:88px; height:88px; border-radius:50%; border:2px solid var(--primary); object-fit:cover; }
    .muted{ color:var(--muted); }
    .ok{ color:#16a34a; font-weight:700; }
    .err{ color:#b91c1c; font-weight:700; }
    .row{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:8px; }
  </style>

  <!-- jsQR -->
  <script defer src="https://unpkg.com/jsqr/dist/jsQR.js"></script>

  <!-- Supabase (usa tu config global) -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script defer src="api.js/supabase-config-caritas.js"></script>
</head>
<body>
  <header>Validar Credencial</header>

  <main class="wrap" role="main">
    <p id="secureWarn" class="muted" style="margin:8px 0;"></p>

    <div class="controls" aria-label="Controles de c√°mara">
      <button class="btn" id="btnIniciar">üé• Iniciar</button>
      <button class="btn" id="btnDetener" disabled>üõë Detener</button>
      <select id="camSelect" aria-label="Seleccionar c√°mara" title="Seleccionar c√°mara" hidden></select>
      <button class="btn" id="btnTorch" hidden>üî¶ Linterna</button>
      <label class="btn" for="fileQR" style="cursor:pointer;">üñºÔ∏è Leer desde imagen</label>
      <input type="file" id="fileQR" accept="image/*" style="display:none"/>
    </div>

    <div class="scan-frame" style="margin-top:8px;">
      <video id="video" autoplay playsinline muted></video>
    </div>

    <div id="output" role="status" aria-live="polite">Apunta la c√°mara a un QR con enlace o JSON de credencial.</div>

    <section id="card" aria-live="polite" aria-label="Resultado de validaci√≥n">
      <img id="foto" class="foto" alt="Foto de la credencial" />
      <div style="margin-top:6px;">
        <div><strong id="nombre">‚Äî</strong></div>
        <div class="muted" id="email">‚Äî</div>
        <div class="muted">C√≥digo: <span id="codigo">‚Äî</span></div>
      </div>
      <div class="row">
        <a id="publicLink" class="btn" href="#" target="_blank" rel="noopener">üåê Abrir credencial p√∫blica</a>
      </div>
    </section>
  </main>

<script>
(() => {
  'use strict';

  // ====== Refs ======
  const video   = document.getElementById('video');
  const output  = document.getElementById('output');
  const card    = document.getElementById('card');
  const foto    = document.getElementById('foto');
  const nombre  = document.getElementById('nombre');
  const email   = document.getElementById('email');
  const codigo  = document.getElementById('codigo');
  const publicLink = document.getElementById('publicLink');

  const btnIniciar = document.getElementById('btnIniciar');
  const btnDetener = document.getElementById('btnDetener');
  const camSelect  = document.getElementById('camSelect');
  const btnTorch   = document.getElementById('btnTorch');
  const fileQR     = document.getElementById('fileQR');
  const secureWarn = document.getElementById('secureWarn');

  // Canvas offscreen
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d', { willReadFrequently:true });

  // Integraci√≥n Supabase
  const supabase = (window.CARITAS && window.CARITAS.supabase) || window.supabase;

  // Estado de c√°mara
  let stream = null;
  let raf = null;
  let currentDeviceId = null;
  let lastUid = null;
  let lastScanAt = 0;
  let torchOn = false;
  let torchTrack = null;

  // Utils
  const avatar = (n) => `https://ui-avatars.com/api/?name=${encodeURIComponent(n||'Usuario')}&background=004aad&color=fff`;
  const setMsg = (html) => output.innerHTML = html;
  const isSecure = () => (location.protocol === 'https:' || location.hostname === 'localhost');

  // ====== UI mensajes sobre origen seguro ======
  secureWarn.textContent = isSecure()
    ? 'Consejo: mant√©n el QR estable y bien iluminado.'
    : '‚ö†Ô∏è Para usar la c√°mara necesitas abrir esta p√°gina con HTTPS o localhost.';

  // ====== Parseo de QR (URL ?id=... o JSON {"uid":"..."}) ======
  function parseQR(data){
    // URL con ?id=
    try{
      const url = new URL(data);
      const uid = url.searchParams.get('id');
      if (uid) return { uid, source:'url' };
    }catch{}
    // JSON
    try{
      const json = JSON.parse(data);
      if (json && json.uid) return { uid: json.uid, source:'json' };
    }catch{}
    // Texto con "...uid=xxxxx" en crudo
    const m = /(?:^|[?&])uid=([^&\s]+)/i.exec(data);
    if (m && m[1]) return { uid:m[1], source:'text' };
    return null;
  }

  // ====== Carga de credencial ======
  async function cargar(uid){
    if (!supabase){ setMsg('<span class="err">‚ùå Supabase no configurado.</span>'); return; }
    try{
      const { data, error } = await supabase
        .from('credenciales')
        .select('*')
        .eq('uid', uid)
        .single();
      if (error || !data) throw error || new Error('No encontrada');
      foto.src = data.foto_url || avatar(data.nombre);
      nombre.textContent = data.nombre || '‚Äî';
      email.textContent  = data.email || '‚Äî';
      codigo.textContent = data.codigo || 'N/A';
      publicLink.href    = `${location.origin}/credencial.html?id=${encodeURIComponent(uid)}`;

      card.style.display = 'block';
      setMsg('<span class="ok">‚úÖ Credencial v√°lida</span>');

      // Vibraci√≥n ligera de feedback (si disponible)
      if (navigator.vibrate) navigator.vibrate(60);
    }catch(e){
      console.error(e);
      card.style.display = 'none';
      setMsg('<span class="err">‚ùå Credencial no v√°lida</span>');
    }
  }

  // ====== Loop de escaneo ======
  function scanLoop(){
    // Throttle para no sobrecargar CPU
    const now = performance.now();
    if (now - lastScanAt < 200) { raf = requestAnimationFrame(scanLoop); return; }
    lastScanAt = now;

    if (video.readyState === video.HAVE_ENOUGH_DATA){
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const img = ctx.getImageData(0,0,canvas.width, canvas.height);
      const code = jsQR(img.data, img.width, img.height, { inversionAttempts: 'dontInvert' });
      if (code){
        const parsed = parseQR(code.data);
        if (parsed && parsed.uid){
          // evitar re-escaneo del mismo UID
          if (parsed.uid !== lastUid){
            lastUid = parsed.uid;
            detener(true); // true => no cambiar mensaje
            setMsg('Leyendo credencial‚Ä¶');
            cargar(parsed.uid);
            return;
          }
        }
      }
    }
    raf = requestAnimationFrame(scanLoop);
  }

  // ====== Encender/Apagar linterna si hay soporte ======
  async function toggleTorch(){
    if (!torchTrack) return;
    try{
      torchOn = !torchOn;
      await torchTrack.applyConstraints({ advanced:[{ torch: torchOn }] });
      btnTorch.textContent = torchOn ? 'üî¶ Linterna (ON)' : 'üî¶ Linterna';
    }catch(e){
      console.warn('Torch no disponible:', e);
      btnTorch.hidden = true;
    }
  }

  // ====== Enumerar c√°maras ======
  async function listCameras(){
    try{
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d => d.kind === 'videoinput');
      if (cams.length > 1){
        camSelect.innerHTML = cams.map(d => `<option value="${d.deviceId}">${d.label || 'C√°mara ' + d.deviceId.slice(-4)}</option>`).join('');
        camSelect.hidden = false;
        // Seleccionar la trasera si la podemos inferir (usualmente la √∫ltima)
        if (!currentDeviceId) currentDeviceId = cams[cams.length-1].deviceId;
        camSelect.value = currentDeviceId;
      }else{
        camSelect.hidden = true;
      }
    }catch(e){
      console.warn('No se pudo listar c√°maras:', e);
      camSelect.hidden = true;
    }
  }

  // ====== Iniciar c√°mara ======
  async function iniciar(){
    if (!isSecure()){
      setMsg('<span class="err">‚ùå C√°mara bloqueada por el navegador (usa HTTPS o localhost).</span>');
      return;
    }
    try{
      btnIniciar.disabled = true;
      btnDetener.disabled = false;

      const constraints = currentDeviceId
        ? { video:{ deviceId:{ exact: currentDeviceId } } }
        : { video:{ facingMode:{ ideal:'environment' } } };

      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      await video.play();

      // Torch support (Chrome Android)
      const track = stream.getVideoTracks()[0];
      const caps = track.getCapabilities && track.getCapabilities();
      if (caps && 'torch' in caps){
        torchTrack = track;
        btnTorch.hidden = false;
        btnTorch.textContent = 'üî¶ Linterna';
      } else {
        btnTorch.hidden = true;
        torchTrack = null;
        torchOn = false;
      }

      await listCameras();
      setMsg('Escaneando‚Ä¶');
      raf = requestAnimationFrame(scanLoop);
    }catch(err){
      console.error(err);
      setMsg('<span class="err">‚ùå No se pudo acceder a la c√°mara.</span>');
      btnDetener.disabled = true;
      btnIniciar.disabled = false;
    }
  }

  // ====== Detener c√°mara ======
  function detener(keepMsg=false){
    if (raf) cancelAnimationFrame(raf);
    raf = null;
    if (video) video.pause();
    if (video && video.srcObject){
      video.srcObject.getTracks().forEach(t => t.stop());
      video.srcObject = null;
    }
    torchOn = false; torchTrack = null;
    btnDetener.disabled = true;
    btnIniciar.disabled = false;
    if (!keepMsg) setMsg('Escaneo detenido.');
  }

  // ====== Cargar QR desde imagen ======
  fileQR.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    try{
      const img = new Image();
      img.onload = () => {
        canvas.width = img.width; canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        const data = ctx.getImageData(0,0,canvas.width,canvas.height);
        const code = jsQR(data.data, data.width, data.height, { inversionAttempts:'dontInvert' });
        if (code){
          const parsed = parseQR(code.data);
          if (parsed?.uid){
            setMsg('Leyendo credencial‚Ä¶');
            cargar(parsed.uid);
          } else {
            setMsg('<span class="err">QR sin UID v√°lido.</span>');
          }
        }else{
          setMsg('<span class="err">No se detect√≥ QR.</span>');
        }
      };
      img.src = URL.createObjectURL(file);
    }catch(err){
      console.error(err);
      setMsg('<span class="err">No se pudo procesar la imagen.</span>');
    }finally{
      e.target.value = '';
    }
  });

  // ====== Listeners UI ======
  btnIniciar.addEventListener('click', iniciar);
  btnDetener.addEventListener('click', () => detener(false));
  camSelect.addEventListener('change', async () => {
    currentDeviceId = camSelect.value || null;
    if (stream) detener(true);
    iniciar();
  });
  btnTorch.addEventListener('click', toggleTorch);

  // Pausar si se cambia de pesta√±a
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) detener(true);
  });

  // Soporte para abrir con ?id=UID (carga directa sin escaneo)
  (function checkDirectId(){
    const uid = new URLSearchParams(location.search).get('id');
    if (uid){
      setMsg('Cargando credencial‚Ä¶');
      cargar(uid);
    }
  })();
})();
</script>
</body>
</html>