<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üë®‚Äçüë©‚Äçüëß Familias Registradas ‚Äî C√°ritas CNC</title>
  <link rel="stylesheet" href="styles-caritas.css" />
  <style>
    body {
      font-family: system-ui, Arial, sans-serif;
      padding: 1rem;
      background: var(--bg,#f6f7fb);
      color: var(--text,#111);
    }
    header { font-size: 1.5rem; margin-bottom: 1rem; text-align: center; }
    #search {
      width: 100%; max-width: 480px; margin: 0 auto 1rem;
      padding: 0.6rem 0.8rem; border:1px solid var(--border,#ddd);
      border-radius:10px; display:block;
    }
    table {
      width: 100%; border-collapse: collapse; background: var(--surface,#fff);
      box-shadow: 0 6px 16px rgba(0,0,0,.06);
      border-radius:12px; overflow:hidden;
    }
    th, td { border-bottom: 1px solid var(--border,#eee); padding: 0.6rem; text-align: left; }
    th { background-color: var(--primary,#b71c1c); color: #fff; }
    a { text-decoration: none; color: var(--accent,#1d4ed8); }
    a:hover { text-decoration: underline; }
    .muted { color: var(--muted,#6b7280); font-size:0.9rem; }
    .status-error { color: #b91c1c; text-align:center; }
    .acciones { display:flex; gap:6px; flex-wrap:wrap; }
    .btn {
      padding:4px 8px; border:1px solid var(--border,#ddd);
      border-radius:6px; cursor:pointer; font-size:0.8rem;
      background:var(--surface-2,#fafafa);
    }
    .btn:hover { background:var(--surface-2-hover,#f0f0f0); }
    .btn-edit { color:#1d4ed8; }
    .btn-del { color:#b91c1c; }
  </style>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js" defer></script>
  <script src="api.js/supabase-config-caritas.js" defer></script>
</head>
<body>

<header>üìã Familias Registradas</header>

<input type="search" id="search" placeholder="üîç Buscar por apellido, direcci√≥n, etc‚Ä¶" aria-label="Buscar familia">

<table id="familiasTable" aria-label="Tabla de familias registradas">
  <thead>
    <tr>
      <th>Nombres</th>
      <th>DNI</th>
      <th>Apellido</th>
      <th>Direcci√≥n</th>
      <th>Fecha</th>
      <th>Tel√©fono</th>
      <th>Observaciones</th>
      <th>Documento</th>
      <th>Mapa</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
document.addEventListener("DOMContentLoaded", ()=>{
  console.log("‚úÖ [Listado Familias] pesta√±a cargada");
  console.log("üîå Supabase conectado:", !!window.CARITAS?.supabase);

  const supabase = window.CARITAS?.supabase;
  const tabla = document.querySelector("#familiasTable tbody");
  const cambios = new Map();
  const msg = document.getElementById("msg");
  let page = 0;
  const pageSize = 20;

  function showMsg(text, type="info"){
    msg.textContent = text;
    msg.className = type;
    console.log(`[MSG-${type}]`, text);
    setTimeout(()=>{ msg.textContent=""; }, 4000);
  }

  const esc = (s="") => String(s).replace(/[&<>"']/g,
    m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
  );

  async function cargarFamilias(){
    console.log("üîç Cargando familias p√°gina:", page);
    try {
      const start = page * pageSize;
      const end = start + pageSize - 1;
      const { data, error } = await supabase
        .from("familias")
        .select("*")
        .order("id",{ascending:true})
        .range(start,end);

      tabla.innerHTML = "";
      if(error) throw error;
      if(!data || data.length===0){
        tabla.innerHTML = "<tr><td colspan='6'>Sin registros</td></tr>";
        console.warn("‚ö†Ô∏è No se encontraron familias en esta p√°gina");
        return;
      }

      console.log("‚úÖ Familias cargadas:", data.length);
      data.forEach(fam=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${fam.id}</td>
          <td>${esc(fam.nombres_apellidos||"")}</td>
          <td>${esc(fam.direccion||"")}</td>
          <td>${esc(fam.telefono_contacto||"")}</td>
          <td><input type="checkbox" data-id="${fam.id}" ${fam.visitada?"checked":""}></td>
          <td><button class="btn btn-del" data-del="${fam.id}">üóë Eliminar</button></td>`;
        tabla.appendChild(tr);
      });
    }catch(err){
      console.error("‚ùå Error cargando familias:", err);
      tabla.innerHTML = "<tr><td colspan='6'>Error al cargar datos</td></tr>";
    }
  }

  // Guardar cambios visitada
  document.getElementById("guardarCambios").addEventListener("click", async ()=>{
    console.log("üíæ Guardando cambios de visitada:", cambios.size, "items");
    try{
      for(const [id,v] of cambios){
        console.log("üì§ Actualizando familia:", id, "visitada=", v);
        await supabase.from("familias").update({visitada:v}).eq("id",id);
      }
      showMsg("‚úÖ Cambios guardados","success");
      cambios.clear();
      cargarFamilias();
    }catch(err){
      console.error("‚ùå Error guardando cambios:", err);
      showMsg("‚ùå Error guardando cambios","error");
    }
  });

  // Detectar cambios en checkboxes
  document.getElementById("familiasTable").addEventListener("change", e=>{
    if(e.target.type==="checkbox"){
      cambios.set(e.target.dataset.id,e.target.checked);
      console.log("‚úèÔ∏è Marcado cambio:", e.target.dataset.id, "->", e.target.checked);
    }
  });

  // Detectar eliminar
  document.getElementById("familiasTable").addEventListener("click", async e=>{
    if(e.target.dataset.del){
      if(confirm("¬øEliminar familia?")){
        console.log("üóëÔ∏è Eliminando familia:", e.target.dataset.del);
        try{
          await supabase.from("familias").delete().eq("id",e.target.dataset.del);
          showMsg("üóëÔ∏è Familia eliminada","success");
          cargarFamilias();
        }catch(err){
          console.error("‚ùå Error eliminando familia:", err);
          showMsg("‚ùå Error eliminando familia","error");
        }
      }
    }
  });

  // Paginaci√≥n
  document.getElementById("prevPage").addEventListener("click",()=>{
    if(page>0){ page--; cargarFamilias(); }
  });
  document.getElementById("nextPage").addEventListener("click",()=>{
    page++; cargarFamilias();
  });

  cargarFamilias();
});
</script>
</body>
</html>