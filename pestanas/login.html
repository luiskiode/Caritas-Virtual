<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Iniciar Sesi√≥n - C√°ritas CNC</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- Firebase compat 10.12.2 (EN ESTE ORDEN) -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- Tu configuraci√≥n (inicializa y expone window.auth/window.db) -->
  <script defer src="firebase-config.js"></script>

  <!-- Controlador robusto (si lo usas, puede ir adem√°s de este inline) -->
  <script defer src="login.js"></script>

  <style>
    body.login-body { display:flex; align-items:center; justify-content:center; min-height:100vh; background:#f6f7fb; margin:0; font-family:system-ui, Arial, sans-serif; }
    .login-container { width: 360px; background:#fff; border:1px solid #eee; border-radius:12px; padding:18px; box-shadow:0 6px 16px rgba(0,0,0,.06); }
    .login-container h1 { margin:0; font-size:1.25rem; color:#b91c1c; }
    .login-container h2 { margin:.35rem 0 1rem; font-size:1rem; color:#111827; }
    form label { display:block; font-size:.9rem; margin:.5rem 0 .25rem; }
    form input { width:100%; padding:.6rem .7rem; border:1px solid #ddd; border-radius:10px; }
    .submit-btn { margin-top: .8rem; width:100%; padding:.6rem .7rem; background:#b91c1c; color:#fff; border:none; border-radius:10px; cursor:pointer; }
    .submit-btn:hover { filter:brightness(0.96); }
    .btn-big { padding: .5rem .8rem; border:1px solid #ddd; background:#fafafa; border-radius:10px; cursor:pointer; }
    #loginMessage { margin-top:.6rem; min-height:1.2rem; font-weight:600; }
    #loginMessage.error { color:#b91c1c; }
    #loginMessage.success { color:#16a34a; }
    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); }
    .modal-content { background:#fff; padding:16px; border-radius:10px; width: 320px; }
  </style>
</head>
<body class="login-body">

<main class="login-container" role="main">
  <h1>C√°ritas CNC</h1>
  <h2>Iniciar sesi√≥n</h2>

  <form id="loginForm" autocomplete="on" novalidate>
    <label for="email">Correo</label>
    <input type="email" id="email" autocomplete="username" required />
    <label for="password">Contrase√±a</label>
    <input type="password" id="password" autocomplete="current-password" required />
    <button type="submit" class="submit-btn">Ingresar</button>
  </form>

  <p id="loginMessage" role="alert" aria-live="polite"></p>

  <div style="text-align:center; margin-top:.5rem;">
    <button class="btn-big" id="resetPassBtn">¬øOlvidaste tu contrase√±a?</button>
  </div>
</main>

<div id="modalReset" class="modal" role="dialog" aria-hidden="true" aria-labelledby="resetTitle">
  <div class="modal-content">
    <h3 id="resetTitle">Recuperar contrase√±a</h3>
    <input type="email" id="resetEmail" placeholder="Ingresa tu correo" />
    <button id="sendReset">Enviar enlace</button>
    <button id="closeModalBtn">Cerrar</button>
    <p id="resetMessage" role="alert" aria-live="polite"></p>
  </div>
</div>

<script>
(function(){
  'use strict';

  // Usa instancias expuestas por firebase-config.js
  const auth = window.auth || (window.firebase && firebase.auth && firebase.auth());
  const db   = window.db   || (window.firebase && firebase.firestore && firebase.firestore());
  if (!auth) {
    console.error('Firebase no inicializado (revisa orden de scripts).');
    const m = document.getElementById('loginMessage');
    if (m) { m.textContent = 'Firebase no inicializado (revisa orden de scripts).'; m.classList.add('error'); }
    return;
  }

  const loginForm = document.getElementById('loginForm');
  const loginMsg  = document.getElementById('loginMessage');

  function setMsg(t, cls){
    if (!loginMsg) return;
    loginMsg.textContent = t || '';
    loginMsg.classList.remove('error','success');
    if (cls) loginMsg.classList.add(cls);
  }

  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    setMsg('','');

    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    if (!email || !password) { setMsg('Completa email y contrase√±a.','error'); return; }

    try {
      const { user } = await auth.signInWithEmailAndPassword(email, password);

      // Rol desde Firestore solo si db existe
      let rol = 'invitado';
      if (db) {
        try {
          const snap = await db.collection('usuarios').doc(user.uid).get();
          rol = snap.exists ? (snap.data().rol || 'invitado') : 'invitado';
        } catch(e) {
          console.warn('No se pudo leer rol en Firestore:', e);
        }
      }

      localStorage.setItem('caritasUser', JSON.stringify({ email: user.email, uid: user.uid, rol }));
      setMsg('‚úî Acceso concedido. Redirigiendo‚Ä¶', 'success');

      setTimeout(() => {
        if (rol === 'admin') location.href = 'index.html';
        else if (rol === 'editor') location.href = 'listado.html';
        else location.href = 'carnet.html';
      }, 900);
    } catch (err) {
      console.error('Error de login:', err);
      const msg = (err.code === 'auth/network-request-failed')
        ? 'Error de red. Verifica tu conexi√≥n.'
        : 'Usuario o contrase√±a incorrectos.';
      setMsg('‚ùå ' + msg, 'error');
    }
  });

  // Reset password
  const modal = document.getElementById('modalReset');
  const resetBtn = document.getElementById('resetPassBtn');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const sendResetBtn = document.getElementById('sendReset');
  const resetMsg = document.getElementById('resetMessage');

  function closeModal(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
  function setResetMsg(t, cls){
    if (!resetMsg) return;
    resetMsg.textContent = t || '';
    resetMsg.classList.remove('error','success');
    if (cls) resetMsg.classList.add(cls);
  }

  resetBtn.addEventListener('click', () => {
    modal.style.display = 'flex';
    setResetMsg('','');
    document.getElementById('resetEmail').value = '';
    modal.setAttribute('aria-hidden','false');
  });
  closeModalBtn.addEventListener('click', closeModal);
  window.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });
  window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeModal(); });

  sendResetBtn.addEventListener('click', async () => {
    const email = document.getElementById('resetEmail').value.trim();
    setResetMsg('','');
    if (!email) { setResetMsg('Ingresa un correo.','error'); return; }
    try { await auth.sendPasswordResetEmail(email); setResetMsg('üì© Si el correo existe, se envi√≥ el enlace.','success'); }
    catch(err){ console.error(err); setResetMsg('‚ùå No se pudo enviar el correo.','error'); }
  });
})();
</script>

</body>
</html>
