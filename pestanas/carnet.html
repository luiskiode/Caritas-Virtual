<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Carnet — Cáritas CNC</title>
  <link rel="stylesheet" href="styles-caritas.css" />
  <!-- QR -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js" defer></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js" defer></script>
  <script src="api.js/firebase-config-caritas.js" defer></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js" defer></script>
  <script src="api.js/supabase-config-caritas.js" defer></script>
</head>
<body>
  <header class="container" style="text-align:center;margin:1rem auto;">
    <h1>📌 Carnet personal</h1>
    <a href="index.html" class="btn-ghost">← Volver al inicio</a>
  </header>

  <main class="container card" style="max-width:400px;text-align:center;">
    <img id="fotoPerfil" src="img/avatar-placeholder.png" alt="Foto de perfil" class="foto" />
    <div class="datos">
      <p><b>Email:</b> <span id="email">—</span></p>
      <p><b>ID Usuario:</b> <span id="uid">—</span></p>
      <p class="codigo"><b>Código:</b> <span id="codigo">—</span></p>
    </div>
    <canvas id="qrCanvas" width="180" height="180"></canvas>
    <div style="margin-top:1rem;display:flex;gap:.5rem;justify-content:center;flex-wrap:wrap;">
      <button class="btn" id="btnLogout">🔒 Cerrar sesión</button>
      <button class="btn-ghost" id="btnCopiar">🔗 Copiar enlace</button>
    </div>
    <div id="msg" style="margin-top:1rem;"></div>
  </main>

<script>
(() => {
  'use strict';
  const supabase = window.CARITAS?.supabase;
  const auth = window.CARITAS?.auth;
  const msgBox = document.getElementById("msg");

  function showMsg(text, type="info"){
    msgBox.textContent = text;
    msgBox.className = type;
    setTimeout(()=>{ msgBox.textContent=""; },4000);
  }

  const esc = (s="") => String(s).replace(/[&<>"']/g,
    m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
  );

  function avatarFallback(nombre){
    return `https://ui-avatars.com/api/?name=${encodeURIComponent(nombre||'Usuario')}&background=111&color=fff`;
  }

  function renderCarnet(user, cred){
    document.getElementById('email').textContent = esc(cred?.email || user.email || '—');
    document.getElementById('uid').textContent = esc(cred?.user_id || user.uid || '—');
    document.getElementById('codigo').textContent = esc(cred?.codigo_verificacion || 'N/A');
    document.getElementById('fotoPerfil').src = cred?.foto_url || avatarFallback(cred?.nombre || user.email);

    const url = `${location.origin}/credencial.html?id=${encodeURIComponent(cred?.user_id || user.uid)}`;
    QRCode.toCanvas(document.getElementById('qrCanvas'), url, err=>{
      if(err) showMsg("❌ Error generando QR","error");
    });
    showMsg("✅ Carnet cargado correctamente","success");
  }

  async function cargarCredencial(uid){
    try {
      const { data, error } = await supabase.from('credenciales').select('*').eq('user_id', uid).single();
      if(error || !data) throw error;
      return data;
    } catch(err){
      console.error(err);
      showMsg("❌ No se encontró tu credencial","error");
      return null;
    }
  }

  function init(){
    if(!supabase || !auth){
      showMsg("❌ Error: servicios no inicializados","error");
      return;
    }
    auth.onAuthStateChanged(async (user) => {
      if (!user){
        showMsg("⚠️ Debes iniciar sesión","error");
        location.href = 'login.html';
        return;
      }
      const cred = await cargarCredencial(user.uid);
      if(cred) renderCarnet(user, cred);
    });
  }

  // Botones
  document.getElementById('btnLogout').addEventListener('click', () => {
    auth?.signOut().then(()=>{
      localStorage.removeItem("caritasUser");
      location.href='login.html';
    });
  });

  document.getElementById('btnCopiar').addEventListener('click', () => {
    const uid = document.getElementById('uid').textContent;
    const url = `${location.origin}/credencial.html?id=${encodeURIComponent(uid)}`;
    navigator.clipboard.writeText(url)
      .then(()=> showMsg("🔗 Enlace copiado al portapapeles","success"))
      .catch(()=> showMsg("❌ No se pudo copiar enlace","error"));
  });

  document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>