<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>👨‍👩‍👧 Familias — Cáritas CNC</title>
  <link rel="stylesheet" href="styles-caritas.css" />

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="api.js/supabase-config-caritas.js"></script>
</head>
<body>
  <header>
    <h1>👨‍👩‍👧 Familias registradas</h1>
    <a href="index.html" class="btn-ghost">← Volver al inicio</a>
  </header>

  <main class="container">
    <div class="card">
      <div id="msg" aria-live="polite"></div>
      <table id="familiasTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombres</th>
            <th>Dirección</th>
            <th>Teléfono</th>
            <th>Visitada</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="pagination">
        <button id="prevPage" class="btn-ghost">⏮ Anterior</button>
        <button id="nextPage" class="btn-ghost">Siguiente ⏭</button>
      </div>

      <button id="guardarCambios" class="btn" disabled>💾 Guardar cambios</button>
    </div>
  </main>

<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("✅ [Listado Familias] pestaña cargada");

  // Validar conexión Supabase
  if(!window.CARITAS?.supabase){
    console.error("❌ Supabase no inicializado. Revisa supabase-config-caritas.js");
    return;
  }
  const supabase = window.CARITAS.supabase;

  const tabla = document.querySelector("#familiasTable tbody");
  const cambios = new Map();
  const msg = document.getElementById("msg");
  const btnGuardar = document.getElementById("guardarCambios");

  let page = 0;
  const pageSize = 20;

  function showMsg(text, type="info"){
    msg.textContent = text;
    msg.className = "msg " + type;
    console.log(`[MSG-${type}]`, text);
    setTimeout(()=>{ msg.textContent=""; msg.className=""; }, 4000);
  }

  const esc = (s="") => String(s).replace(/[&<>"']/g,
    m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
  );

  async function cargarFamilias(){
    console.log("🔍 Cargando familias, página:", page);
    try {
      const start = page * pageSize;
      const end = start + pageSize - 1;

      const { data, error } = await supabase
        .from("familias")
        .select("*")
        .order("id", { ascending:true })
        .range(start, end);

      tabla.innerHTML = "";

      if(error) throw error;
      if(!data || data.length===0){
        tabla.innerHTML = "<tr><td colspan='6'>Sin registros</td></tr>";
        return;
      }

      console.log("✅ Familias cargadas:", data.length);
      data.forEach(fam => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(fam.id)}</td>
          <td>${esc(fam.nombres_apellidos||"")}</td>
          <td>${esc(fam.direccion||"")}</td>
          <td>${esc(fam.telefono_contacto||"")}</td>
          <td><input type="checkbox" data-id="${fam.id}" ${fam.visitada?"checked":""}></td>
          <td><button class="btn btn-del" data-del="${fam.id}">🗑 Eliminar</button></td>`;
        tabla.appendChild(tr);
      });
    }catch(err){
      console.error("❌ Error cargando familias:", err);
      tabla.innerHTML = "<tr><td colspan='6'>Error al cargar datos</td></tr>";
    }
  }

  // Guardar cambios visitada
  btnGuardar.addEventListener("click", async ()=>{
    if(cambios.size === 0) return;

    console.log("💾 Guardando cambios visitada:", cambios.size);
    try{
      const updates = [];
      for(const [id,v] of cambios){
        updates.push(
          supabase.from("familias").update({ visitada:v }).eq("id", id)
        );
      }
      await Promise.all(updates);

      showMsg("✅ Cambios guardados","success");
      cambios.clear();
      btnGuardar.disabled = true;
      cargarFamilias();
    }catch(err){
      console.error("❌ Error guardando cambios:", err);
      showMsg("❌ Error guardando cambios","error");
    }
  });

  // Detectar cambios en checkboxes
  document.getElementById("familiasTable").addEventListener("change", e=>{
    if(e.target.type==="checkbox"){
      cambios.set(e.target.dataset.id, e.target.checked);
      btnGuardar.disabled = cambios.size === 0;
    }
  });

  // Detectar eliminar
  document.getElementById("familiasTable").addEventListener("click", async e=>{
    if(e.target.dataset.del){
      if(confirm("¿Eliminar familia?")){
        console.log("🗑️ Eliminando familia:", e.target.dataset.del);
        try{
          await supabase.from("familias").delete().eq("id", e.target.dataset.del);
          showMsg("🗑️ Familia eliminada","success");
          cargarFamilias();
        }catch(err){
          console.error("❌ Error eliminando familia:", err);
          showMsg("❌ Error eliminando familia","error");
        }
      }
    }
  });

  // Paginación
  document.getElementById("prevPage").addEventListener("click",()=>{
    if(page>0){ page--; cargarFamilias(); }
  });
  document.getElementById("nextPage").addEventListener("click",()=>{
    page++; cargarFamilias();
  });

  cargarFamilias();
});
</script>
</body>
</html>
