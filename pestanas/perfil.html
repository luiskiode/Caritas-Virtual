<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>üë§ Mi Perfil / Credencial ‚Äî C√°ritas CNC</title>
  <link rel="stylesheet" href="../estilos-familias.css">

  <!-- Fuente Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

  <!-- QR -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="../api.js/firebase-config-caritas.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="../api.js/supabase-config-caritas.js"></script>

  <style>
    body { font-family: 'Poppins', sans-serif; background:#0a0a0a; color:#f0f0f0; }
    h1 { text-align:center; margin:1.5rem 0; font-weight:600; }
    .perfil-card {
      display: flex; align-items: center; justify-content: space-between; gap: 1rem;
      max-width: 850px; margin: 0 auto; padding: 20px; border-radius: 16px;
      background: rgba(30,30,30,0.85); backdrop-filter: blur(8px);
      box-shadow: 0 6px 18px rgba(0,0,0,.4);
    }
    .perfil-left img {
      width: 120px; height: 120px; border-radius: 12px;
      border: 3px solid #b91c1c; object-fit: cover;
    }
    .perfil-center { flex: 1; min-width: 300px; }
    .perfil-center h2 { margin:0; font-weight:600; }
    .perfil-center p { margin:.2rem 0; }
    .badge {
      display:inline-block; background:#b91c1c; color:#fff; padding:4px 10px;
      border-radius:20px; font-size:0.85rem; margin:4px 0;
    }
    .codigo { font-weight:600; color:#4da3ff; margin:0.5rem 0; }
    .acciones { margin-top:.5rem; display:flex; flex-wrap:wrap; gap:6px; }
    .acciones button {
      padding:6px 10px; background:#222; border:none; border-radius:8px;
      color:#fff; cursor:pointer; font-size:0.85rem;
    }
    .acciones button:hover { background:#333; }
    .perfil-right { text-align:center; }
    .perfil-right canvas { background:#fff; padding:6px; border-radius:8px; }
    .perfil-right small { display:block; color:#aaa; margin-top:6px; font-size:0.8rem; }
    #formEditar {
      max-width: 850px; margin: 1rem auto; padding: 15px; border-radius: 12px;
      background: rgba(40,40,40,0.8); display:none;
    }
    #formEditar input, #formEditar select {
      display:block; width:100%; margin:.4rem 0; padding:.5rem;
      border-radius:8px; border:1px solid #444; background:#222; color:#fff;
    }
    #formEditar button {
      margin-top:.5rem; padding:.6rem; border:none; border-radius:8px;
      background:#007bff; color:#fff; cursor:pointer;
    }
    #formEditar button:hover { background:#0056b3; }
  </style>
</head>
<body>
  <h1>üë§ Mi Perfil / Credencial</h1>

  <div class="perfil-card">
    <div class="perfil-left">
      <img id="fotoPerfil" src="../img/avatar-placeholder.png" alt="Foto de perfil">
    </div>

    <div class="perfil-center">
      <h2 id="nombrePerfil">‚Äî</h2>
      <p id="emailPerfil">‚Äî</p>
      <span id="rolPerfil" class="badge">Voluntario C√°ritas CNC</span>
      <p class="codigo">C√≥digo: <span id="codigoPerfil">‚Äî</span></p>
      <div class="acciones">
        <button id="btnEditar">‚úèÔ∏è Editar</button>
        <button id="btnCopiar">üîó Copiar enlace</button>
        <button id="btnDescargar">‚¨áÔ∏è Descargar QR</button>
        <button id="btnLogout">üîí Cerrar sesi√≥n</button>
      </div>
    </div>

    <div class="perfil-right">
      <canvas id="qrCanvas" width="140" height="140"></canvas>
      <small>üì≤ QR de tu credencial</small>
    </div>
  </div>

  <!-- Formulario de edici√≥n -->
  <form id="formEditar">
    <h3>Editar perfil</h3>
    <input type="text" id="editNombre" placeholder="Nombre completo">
    <select id="editRol">
      <option value="Voluntario C√°ritas CNC">Voluntario C√°ritas CNC</option>
      <option value="Administrador">Administrador</option>
    </select>
    <input type="file" id="editFoto" accept="image/*">
    <button type="submit">üíæ Guardar cambios</button>
  </form>

<script>
document.addEventListener("DOMContentLoaded", ()=>{
  const auth = window.CARITAS?.auth;
  const supabase = window.CARITAS?.supabase;

  const nombreEl = document.getElementById("nombrePerfil");
  const emailEl = document.getElementById("emailPerfil");
  const rolEl = document.getElementById("rolPerfil");
  const fotoEl = document.getElementById("fotoPerfil");
  const codigoEl = document.getElementById("codigoPerfil");
  const qrCanvas = document.getElementById("qrCanvas");
  const formEditar = document.getElementById("formEditar");

  let credencialData = null;

  async function cargarPerfil(user){
    const { data, error } = await supabase.from("credenciales")
      .select("*")
      .eq("user_id", user.uid)
      .single();

    if(error){ console.error("‚ùå Error cargando perfil:", error); return; }

    credencialData = data;
    const nombre = data?.nombre || user.displayName || (user.email?.split("@")[0]) || "Usuario";
    const rol = data?.rol || "Voluntario C√°ritas CNC";
    const fotoUrl = data?.foto_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(nombre)}&background=111&color=fff`;
    const codigo = data?.codigo_verificacion || user.uid.substring(0,8).toUpperCase();

    nombreEl.textContent = nombre;
    emailEl.textContent = data?.email || user.email;
    rolEl.textContent = rol;
    fotoEl.src = fotoUrl;
    codigoEl.textContent = codigo;

    QRCode.toCanvas(qrCanvas, `${location.origin}/credencial.html?id=${user.uid}`);
  }

  auth?.onAuthStateChanged(user=>{
    if(!user){ location.href="login.html"; return; }
    cargarPerfil(user);
  });

  // Editar perfil
  document.getElementById("btnEditar").addEventListener("click", ()=>{
    formEditar.style.display = formEditar.style.display === "block" ? "none" : "block";
    document.getElementById("editNombre").value = credencialData?.nombre || "";
    document.getElementById("editRol").value = credencialData?.rol || "Voluntario C√°ritas CNC";
  });

  formEditar.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const user = auth.currentUser;
    const nuevoNombre = document.getElementById("editNombre").value.trim();
    const nuevoRol = document.getElementById("editRol").value;
    const fotoFile = document.getElementById("editFoto").files[0];

    let fotoUrl = credencialData?.foto_url;

    // Subir foto al bucket credenciales-fotos
    if(fotoFile){
      const filePath = `${user.uid}/${Date.now()}_${fotoFile.name}`;
      const { error: uploadError } = await supabase.storage
        .from("credenciales-fotos")
        .upload(filePath, fotoFile, { upsert: true });

      if (uploadError) {
        console.error("‚ùå Error subiendo foto:", uploadError);
        alert("No se pudo subir la foto");
      } else {
        const { data: publicUrl } = supabase.storage
          .from("credenciales-fotos")
          .getPublicUrl(filePath);
        fotoUrl = publicUrl.publicUrl;
      }
    }

    const { error: updateError } = await supabase.from("credenciales").update({
      nombre: nuevoNombre,
      rol: nuevoRol,
      foto_url: fotoUrl
    }).eq("user_id", user.uid);

    if(updateError){
      console.error("‚ùå Error actualizando perfil:", updateError);
      alert("Error al actualizar perfil");
    } else {
      alert("‚úÖ Perfil actualizado");
      formEditar.style.display="none";
      cargarPerfil(user);
    }
  });

  // Copiar enlace
  document.getElementById("btnCopiar").addEventListener("click", ()=>{
    const uid = auth.currentUser?.uid;
    if(!uid) return;
    const url = `${location.origin}/credencial.html?id=${encodeURIComponent(uid)}`;
    navigator.clipboard.writeText(url)
      .then(()=> alert("üîó Enlace copiado"))
      .catch(()=> prompt("Copia el enlace:", url));
  });

  // Descargar QR
  document.getElementById("btnDescargar").addEventListener("click", ()=>{
    const link = document.createElement("a");
    link.download = "credencial-qr.png";
    link.href = qrCanvas.toDataURL("image/png");
    link.click();
  });

  // Logout
  document.getElementById("btnLogout").addEventListener("click", ()=>{
    auth.signOut(); 
    localStorage.removeItem("caritasUser");
    location.href="login.html";
  });
});
</script>
</body>
</html>